---
title: "Set up Markdown report"
output:
  word_document:
    reference_docx: template.docx
---

Markdown dynamic reporting allows for a streamlined, reliable, and reproducible way to generate reports. This is especially useful when the report is generated on a regular basis, or when the report is generated by multiple people. The report is generated from a single source - which is the R Markdown file. This means that the report is always up-to-date and consistent.

Setting up markdown report within a project involves the following steps:

- Create a template word document, sutuate in folder **"Utils"**.

- Create an **.R** files for chapters, situate in folder **"Chapters"**. "Index.Rmd" is the main file that calls all the chapters.

- Create a **.R** scripts containing functions for report elements, situate in folder **"R"**.

- Create **.R** for parameter setting, situate in **WD**, source via **.Rprofile** file.

To further divide the volume of code create the following additional files (use _ in front of all of them):

- **bookdown.yml** contains the configuration for the bookdown package, situate in **WD**.

- **bookdown_(param).yml** contains configuration for the bookdown package for each parameter, situate in folder **"YML"**.

- **output.yml** contains the configuration for the output format, situate in **WD**.

## Index.Rmd

1. Specify the fillowing on top of the file:

```{r index_yaml, eval=FALSE, echo=TRUE}

---
output: 
  word_document:
    keep_md: true
  html_document:
    toc: true
    number_sections: true
description: give_report_a_description
site: bookdown::bookdown_site
---

```

2. Set up knitr options:

```{r knitr_setup, eval=FALSE, echo=TRUE}


{r knitr_setup, echo = FALSE, eval = TRUE, error = TRUE}
rm(list = ls())
# Set global chunk options
knitr::opts_chunk$set(
  echo    = FALSE, # Show code in the output
  eval    = TRUE,  # Evaluate code
  warning = FALSE, # Suppress warnings
  message = FALSE, # Suppress messages
  error   = TRUE,   # Show errors
  cache   = FALSE  # Cache the results (not recommended)
  )

```

3. Ensure the appropriate locale:

```{r locale, eval=FALSE, echo=TRUE}

{r eng_locale, echo=FALSE, results='hide'}
#change locale to English
Sys.setlocale("LC_TIME", "English")

```

4. Load the necessary libraries:

```{r load_libraries, eval=FALSE, echo=TRUE}

{r load_libraries}
#rm(list = ls())
options(repos = c(CRAN = "https://cran.r-project.org"))


packages <- c("labelled", "openxlsx", "MASS", "geepack", "emmeans",
              "brms", "posterior", "bayesplot",
              "tidyverse", "data.table", "lubridate", "glue",
              "survival", "survminer", "ggsurvfit",
              "gtsummary", "gt", "gtExtras", "kableExtra",
              "officer", "officedown", "flextable", "lorem", "knitr",
              "effectsize", "consort",
              "showtext", "extrafont", "ftExtra", "patchwork", "here", "wrappedtools",
              "WRS2", "rstatix"
                )
  
  for (package in packages) {
    suppressMessages(
    suppressWarnings({
      if (!require(package, character.only = TRUE)) {
        install.packages(package, dependencies = TRUE)
        library(package, character.only = TRUE)
        }
      })
    )
  }

```

5. Load the necessary data:

```{r load_data, eval=FALSE, echo=TRUE}

{r load_data}
load("./Data/data_all.RData")
var_labels <- openxlsx::read.xlsx(here::here("Utils", "var_labels.xlsx"), sheet = 1)

```

6. Load all scripst from **.R** folder:

```{r load_scripts, eval=FALSE, echo=TRUE}

{r source_functions}
# Define the folder containing the R scripts
r_folder_path <- here::here("R")

# Get all .R files in the folder
r_scripts <- list.files(path = r_folder_path, pattern = "\\.R$", full.names = TRUE)
 
# Loop through each R file and source it
for (r_script in r_scripts) {
  source(r_script, local = knitr::knit_global())
  }
```

7. All r chunks must be enveloped in three tics **```**.

8. Cover page can be included in Index file.

\

## Rendering the report with parameters

1. In **.Rprofile** file call the following function:

```{r rprofile, eval=FALSE, echo=TRUE}

source("render_report.R")

```

2. in **render_report.R** file specify the following function:

```{r render_report, eval=FALSE, echo=TRUE}

# Function to render individual mini reports
# Loaded at project start-up (sourced in the .Rprofile file)
# Options are:
# - "full" - Full report
# - "intro" - only Introductory chapters (Signatures, Abbreviations, Introduction, etc)
# - "demo" - only Demographics chapter
# - "res" - only Results chapters
# - "prim" - only Primary efficacy results chapter
# - "ksec" - only Key Secondary efficacy results chapter
# - "sec" - only Secondary efficacy results chapter
# - "safe" - only Safety results chapter
# - "all" - all tables and figures
# example RUN: render_report("prim")

render_report <- function(config) {
  
  config_file <- paste0("YML/_bookdown_", config, ".yml")
  
  if (!file.exists(config_file)) {
        stop("Configuration file does not exist: ", config_file)
    }

  file.copy(config_file, "_bookdown.yml", overwrite = TRUE)

  params <<- list(report_type = config)

  bookdown::render_book("index.Rmd")

}

```

Parameters must be connected to each chapters name in **Chapters** and **YML** folders. As a result of calling **render_report("prim")** function, the report will be rendered with only Primary efficacy results chapter and cover page. The specific chapter **.yml** in **YML** folder will substitute the general **bookdown.yml** file in **WD**.

3. In **YML** folder create **bookdown_prim.yml** file with the following content:

```{r yml, eval=FALSE, echo=TRUE}

book_filename: 'Linola-Primary'
new_session: no
rmd_files: ["index.Rmd", "./chapters/06.2-results-efficacy-primary.Rmd"]
delete_merged_file: yes

```

Other chapters must follow the same principal, use chapter names from **Chapters** folder.

4. It rendering a chain of chapters is necessary (ex. all results chapters OR full report), specify the following information at the end of each chapter in a chain:

```{r chain, eval=FALSE, echo=TRUE}

{r chapter_name, eval = params$report_type %in% c("full", "res"), child = here::here("Chapters", "name_of_next_chapter.Rmd")}
```

\

## Output.yml

1. In **output.yml** file in **WD** specify the following:

```{r output, eval=FALSE, echo=TRUE}

bookdown::markdown_document2:
  base_format: officedown::rdocx_document
  reference_docx: utils/template2.docx
  keep_md: yes
  mapstyles:
    Normal: ['First Paragraph', 'Body Text']
  tables:
    style: Table
    layout: autofit
    width: 1.0
    topcaption: true
    tab.lp: 'tab:'
    caption:
      style: Caption Table
      pre: 'Table '
      sep: ': '
      tnd: 2
      tns: '-'
      fp_text: !expr officer::fp_text_lite(bold = TRUE)
  plots:
    style: Normal
    align: left
    fig.lp: 'fig:'
    topcaption: false
    caption:
      style: Caption Figure
      pre: 'Figure '
      sep: ': '
      tnd: 2
      tns: '-'
      fp_text: !expr officer::fp_text_lite(bold = TRUE)
    fig.width: 6
    fig.height: 4
    fig.align: 'center'
    dev: 'png'
    dpi: 300
  page_size:
    width: 8.3
    height: 11.7
    orient: "portrait"
  page_margins:
    bottom: 1
    top: 1
    right: 1
    left: 1
    header: 1
    footer: 1
    gutter: 0
  reference_num: false

bookdown::gitbook:
  config:
    toc:
      collapse: subsection
      scroll_highlight: true
      before: null
      after: null
    toolbar:
      position: fixed
    download: ["pdf", "epub", "mobi"] 
    search:
      engine: lunr
      options: null
    fontsettings:
      theme: white
      family: sans
      size: 2
    info: true

```

